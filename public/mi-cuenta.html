<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mis widgets</title>
  <style>
    body{font-family:system-ui,sans-serif;margin:24px;max-width:720px}
    ul{list-style:none;padding:0;display:grid;gap:12px}
    li{border:1px solid #e5e5e5;border-radius:8px;padding:12px}
    .actions{margin-top:16px}
    button{padding:10px 16px;border:1px solid #ddd;border-radius:8px;cursor:pointer;background:#fff}
    @media (max-width:375px){body{font-size:16px}}
  </style>
</head>
<body>
  <h1>Mis widgets</h1>
  <div id="msg"></div>
  <ul id="list"></ul>
  <div class="actions">
    <button id="newBtn">Crear otro widget</button>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const cid = params.get("customer_id");
    const msg = document.getElementById("msg");
    const list = document.getElementById("list");
    const btn  = document.getElementById("newBtn");

    async function loadSites() {
      msg.textContent = "Cargando…";
      const r = await fetch(`/api/sites?customer_id=${encodeURIComponent(cid)}`);
      const data = await r.json().catch(()=>[]);
      msg.textContent = "";
      list.innerHTML = "";
      if (!Array.isArray(data) || data.length === 0) {
        msg.textContent = "No tienes widgets creados aún. Crea uno desde tu Magic Link.";
        return;
      }
      data.forEach(s => {
        const li = document.createElement("li");
        li.innerHTML =
          `<div><strong>DB:</strong> ${s.notion_database_id}</div>` +
          `<div><strong>Creado:</strong> ${new Date(s.created_at).toLocaleString()}</div>`;
        list.appendChild(li);
      });
    }

    async function createWidget() {
      if (!cid) { alert("Falta customer_id en la URL."); return; }
      const dbid = prompt("Pega el Notion Database ID para el nuevo widget:");
      if (!dbid) return;

      msg.textContent = "Creando widget…";
      const r = await fetch("/api/widgets/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ customer_id: cid, notion_database_id: dbid })
      });
      const data = await r.json().catch(()=>null);
      if (!r.ok) {
        console.error("Error:", data);
        msg.textContent = "Error creando widget. Revisa la consola.";
        return;
      }
      msg.textContent = "Widget creado.";
      await loadSites();
    }

    if (!cid) {
      msg.textContent = "Agrega ?customer_id=UUID a la URL para ver y crear widgets.";
      btn.disabled = true;
    } else {
      btn.addEventListener("click", createWidget);
      loadSites();
    }
  </script>
</body>
</html>
