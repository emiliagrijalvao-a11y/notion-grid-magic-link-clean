<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mis widgets</title>
  <style>
    body{font-family:system-ui,sans-serif;margin:24px;max-width:820px}
    ul{list-style:none;padding:0;display:grid;gap:12px}
    li{border:1px solid #e5e5e5;border-radius:8px;padding:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .muted{color:#666}
    button{padding:8px 12px;border:1px solid #ddd;border-radius:8px;background:#fff;cursor:pointer}
    .actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .toast{position:fixed;right:16px;bottom:16px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transition:.2s}
    .toast.show{opacity:1}
    @media (max-width:375px){body{font-size:16px}}
  </style>
</head>
<body>
  <h1>Mis widgets</h1>
  <div id="msg"></div>
  <ul id="list"></ul>
  <div class="actions">
    <button id="newBtn">Crear otro widget</button>
  </div>
  <div id="toast" class="toast">Copiado</div>

  <script>
    const params = new URLSearchParams(location.search);
    const cid = params.get("customer_id");
    const msg = document.getElementById("msg");
    const list = document.getElementById("list");
    const btn  = document.getElementById("newBtn");
    const toast= document.getElementById("toast");

    function showToast(text="Copiado"){
      toast.textContent=text; toast.classList.add("show");
      setTimeout(()=>toast.classList.remove("show"), 1200);
    }

    async function loadSites() {
      msg.textContent = "Cargando…";
      const r = await fetch(`/api/sites?customer_id=${encodeURIComponent(cid)}`);
      const data = await r.json().catch(()=>[]);
      msg.textContent = "";
      list.innerHTML = "";
      if (!Array.isArray(data) || data.length === 0) {
        msg.textContent = "No tienes widgets creados aún. Crea uno desde tu Magic Link.";
        return;
      }
      data.forEach(s => {
        const li = document.createElement("li");
        const widgetLink  = `${location.origin}/widget.html?wid=${s.id}`;
        const iframeCode  = `<iframe src="${widgetLink}" width="100%" height="500" style="border:0;"></iframe>`;

        li.innerHTML =
          `<div class="row"><strong>DB:</strong> ${s.notion_database_id} <span class="muted">· ID: ${s.id}</span></div>` +
          `<div class="muted">Creado: ${new Date(s.created_at).toLocaleString()}</div>` +
          `<div class="actions">
             <button class="copy-link">Copiar link</button>
             <button class="copy-iframe">Copiar iframe</button>
           </div>`;

        li.querySelector(".copy-link").addEventListener("click", async ()=> {
          await navigator.clipboard.writeText(widgetLink);
          showToast("Link copiado");
        });
        li.querySelector(".copy-iframe").addEventListener("click", async ()=> {
          await navigator.clipboard.writeText(iframeCode);
          showToast("Iframe copiado");
        });
        list.appendChild(li);
      });
    }

    async function createWidget() {
      if (!cid) { alert("Falta customer_id en la URL."); return; }
      const dbid = prompt("Pega el Notion Database ID para el nuevo widget:");
      if (!dbid) return;

      msg.textContent = "Creando widget…";
      const r = await fetch("/api/widgets/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ customer_id: cid, notion_database_id: dbid })
      });
      const data = await r.json().catch(()=>null);
      if (!r.ok) { console.error("Error:", data); msg.textContent = "Error creando widget."; return; }
      msg.textContent = "Widget creado.";
      await loadSites();
    }

    if (!cid) {
      msg.textContent = "Agrega ?customer_id=UUID a la URL para ver y crear widgets.";
      btn.disabled = true;
    } else {
      btn.addEventListener("click", createWidget);
      loadSites();
    }
  </script>
</body>
</html>
