<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Widget · Grid</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root{
      --bg: transparent;          /* fondo transparente para Notion */
      --tile: #f3f3f3;
      --border: #e5e5e5;
      --text: #111;
      --overlayText: #fff;
      --gap: 8px;
      --radius: 0;                /* look cuadrado tipo IG */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    }

    .wrap{padding:0;margin:0}

    /* GRID estilo Instagram */
    .grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);   /* 3 columnas fijas para “look IG” */
      gap: var(--gap);
      width:100%;
    }
    @media (max-width: 760px){
      .grid{ grid-template-columns: repeat(2, 1fr); }
    }

    .item{
      position:relative; border:1px solid var(--border); background:var(--tile);
      overflow:hidden; border-radius:var(--radius);
      aspect-ratio:1/1; /* cuadrado perfecto */
    }
    .ph{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      font-size:12px; color:#777;
    }
    .img{
      position:absolute; inset:0; width:100%; height:100%; object-fit:cover;
      display:block; background:#ddd;
    }

    /* overlay con título al pasar mouse, muy sutil */
    .overlay{
      position:absolute; left:0; right:0; bottom:0; padding:8px 10px;
      background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.55) 90%);
      color:var(--overlayText); font-size:12px; line-height:1.3;
      opacity:0; transition:opacity .15s ease;
    }
    .item:hover .overlay{opacity:1}

    /* indicador “clicable” (cuando hay href) */
    .item.link{ cursor:pointer }
    .item.link:active{ transform: translateY(1px) }

    /* estados */
    .state{padding:16px; font-size:14px; color:#666}
    .visually-hidden{position:absolute!important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px)}
  </style>
</head>
<body>
  <div class="wrap">
    <div id="state" class="state">Cargando…</div>
    <div id="grid" class="grid" hidden></div>
  </div>

  <script>
    // ========= Helpers =========
    const qs = new URLSearchParams(location.search);
    const forwardParams = (() => {
      // Reenviamos TODOS los params (id, db, limit, etc.) a /api/grid para no romper flujos existentes.
      const arr = [];
      for (const [k,v] of qs.entries()) arr.push(`${encodeURIComponent(k)}=${encodeURIComponent(v)}`);
      return arr.length ? `?${arr.join("&")}` : "";
    })();

    const $state = document.getElementById("state");
    const $grid  = document.getElementById("grid");

    function showState(msg){ $state.textContent = msg; $state.hidden = false; $grid.hidden = true }
    function showGrid(){ $state.hidden = true; $grid.hidden = false }

    function el(tag, attrs={}, children=[]){
      const n = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v])=>{
        if (k === "class") n.className = v;
        else if (k === "style") n.setAttribute("style", v);
        else if (k in n) n[k] = v;
        else n.setAttribute(k, v);
      });
      [].concat(children).forEach(c => n.appendChild(typeof c === "string" ? document.createTextNode(c) : c));
      return n;
    }

    // ========= Render de tarjeta GRID estilo IG =========
    function renderItem(item){
      const hasHref = !!item.href;
      const node = el("div", { class: "item" + (hasHref ? " link" : "") });

      // imagen / placeholder
      if (item.image){
        node.appendChild(el("img", { class:"img", alt: item.title || "", src: item.image }));
      } else {
        node.appendChild(el("div", { class:"ph" }, "Sin imagen"));
      }

      // overlay con título al hover
      if (item.title){
        node.appendChild(el("div", { class:"overlay" }, item.title));
      }

      // click → abre href (si existe)
      if (hasHref){
        node.addEventListener("click", () => {
          try {
            const u = new URL(item.href);
            window.open(u.href, "_blank", "noopener");
          } catch {
            // si no es URL válida, ignoramos el click
          }
        });
      }

      return node;
    }

    // ========= Carga de datos desde /api/grid =========
    async function load(){
      try{
        const r = await fetch(`/api/grid${forwardParams}`, { headers:{ Accept:"application/json" } });
        if(!r.ok){
          const txt = await r.text();
          throw new Error(`Error /api/grid ${r.status}: ${txt}`);
        }
        const j = await r.json();

        const items = Array.isArray(j.items) ? j.items : [];

        if (!items.length){
          showState("No hay elementos para mostrar.");
          return;
        }

        // Limpia y dibuja
        $grid.innerHTML = "";
        items.forEach(it => $grid.appendChild(renderItem(it)));
        showGrid();
      }catch(e){
        console.error(e);
        showState("No se pudo cargar el grid.");
      }
    }

    load();
  </script>
</body>
</html>
