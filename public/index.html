<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Setup · Flujo Creativo</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    /* mínimos seguros por si faltan en styles.css (no rompe tu tema) */
    body{color:#111;background:#f7f7f7;font:16px/1.45 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    header{display:flex;align-items:center;gap:16px;margin-bottom:12px}
    .brand{font-family:Oswald,Inter,system-ui,sans-serif;font-weight:700;letter-spacing:.5px}
    nav{display:flex;gap:12px;margin:12px 0 24px}
    nav a{display:inline-block;padding:8px 14px;border:1px solid #000;background:#fff;color:#000;text-decoration:none}
    nav a.active{background:#000;color:#fff}
    .card{background:#fff;border:1px solid #000;padding:18px;margin:18px 0}
    .field{display:block;margin:14px 0}
    .field .label{font-weight:700;margin-bottom:6px}
    .muted{opacity:.65;font-weight:400}
    input[type="text"],input[type="email"],input[type="url"]{width:100%;padding:10px 12px;border:1px solid #000;background:#fff}
    button.primary{background:#000;color:#fff;border:1px solid #000;padding:12px 18px;cursor:pointer}
    details{margin:8px 0}
    summary{cursor:pointer}
    .alert{border:1px solid #000;background:#ECEBE8;padding:12px;margin:16px 0}
    .ok{border-color:#0a0;background:#eaffea}
    .err{border-color:#a00;background:#ffecec}
    table.faq{width:100%;border-collapse:collapse}
    .list{margin:0;padding-left:18px}
    .small{font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">FLUJO CREATIVO</div>
    </header>

    <nav>
      <a href="#start"   data-tab="start"   class="active">Empieza aquí</a>
      <a href="#setup"   data-tab="setup">Setup</a>
      <a href="#help"    data-tab="help">Help</a>
      <a href="#account" data-tab="account">Account</a>
    </nav>

    <!-- Empieza aquí (copia “buena” que querías conservar) -->
    <section id="tab-start">
      <h1>Planifica tu feed de Instagram trayendo tu Grid a Notion</h1>
      <p>En pocos pasos tendrás una galería estilo Instagram que se actualiza automáticamente.</p>

      <h3>Sigue estos pasos:</h3>
      <div class="card">
        <p><strong>1. Prepara tu contenido en Notion</strong></p>
        <p><strong>OPCIÓN 1: Usa nuestro template (recomendado)</strong><br>
        Duplica el template para obtener una base de datos lista con imágenes de ejemplo en tu Notion. Asegúrate de que todo funcione correctamente antes de cambiar a tu propio sistema.</p>
        <p><a href="https://www.notion.so/templates" target="_blank" rel="noopener">
          <button class="primary">Duplicar template →</button></a></p>

        <p><strong>OPCIÓN 2: Crea tu propia base de datos</strong><br>
        Si prefieres empezar desde cero o modificar una base existente, asegúrate de que tenga estas propiedades básicas:</p>

        <table class="faq" border="1" cellpadding="8">
          <thead><tr><th>Propiedad</th><th>Tipo</th><th>Propósito</th></tr></thead>
          <tbody>
            <tr><td>Name</td><td>Text</td><td>Se muestra al pasar sobre imágenes.</td></tr>
            <tr><td>Publish Date</td><td>Date</td><td>Determina el orden cronológico.</td></tr>
            <tr><td>Attachment</td><td>File</td><td>Imágenes/Vídeos locales (Basic y Pro).</td></tr>
            <tr><td>Image Source</td><td>Select</td><td>Pro: <em>Attachment</em> / <em>Link</em> / <em>Canva Design</em>.</td></tr>
            <tr><td>Link</td><td>Text</td><td>Pro: enlaces externos (imágenes/vídeos).</td></tr>
            <tr><td>Canva Link</td><td>URL</td><td>Pro: enlace de “Embed” de Canva.</td></tr>
          </tbody>
        </table>

        <p class="small"><strong>Importante:</strong> Copia la URL de la <em>base de datos real</em> (vista de página completa), no de una vista vinculada.</p>
      </div>
    </section>

    <!-- Setup (solo añadimos Bio + mandamos bio_db_url) -->
    <section id="tab-setup" style="display:none">
      <h1>Widget Setup</h1>

      <div class="card">
        <label class="field" for="email">
          <div class="label">Correo <span class="muted">(para identificar tu cuenta)</span></div>
          <input id="email" type="email" placeholder="tu-correo@ejemplo.com">
        </label>

        <label class="field" for="notionToken">
          <div class="label">Notion Integration Token</div>
          <input id="notionToken" type="text" placeholder="secret_xxxxx...">
        </label>

        <details class="help">
          <summary>+ Instrucciones</summary>
          <div class="help-body">
            <ol class="list">
              <li>Crea tu integración: <a href="https://www.notion.so/my-integrations" target="_blank" rel="noopener">Notion Integrations</a>.</li>
              <li>Copia el token (“Internal Integration Token”).</li>
              <li>En cada base (Grid y, si usas, Bio) haz <strong>••• → Connect to</strong> y selecciona tu integración.</li>
            </ol>
          </div>
        </details>

        <!-- Grid -->
        <label class="field" for="gridDbUrl">
          <div class="label">Database URL — Grid</div>
          <input id="gridDbUrl" type="url" placeholder="https://www.notion.so/... (base de Grid)">
        </label>

        <details class="help">
          <summary>+ Cómo obtener este enlace</summary>
          <div class="help-body small">
            Abre la base en vista de página completa y copia la URL del navegador. Evita vistas vinculadas.
          </div>
        </details>

        <!-- Bio (nuevo, opcional) -->
        <label class="field" for="bioDbUrl">
          <div class="label">Database URL — Bio Settings <span class="muted">(opcional)</span></div>
          <input id="bioDbUrl" type="url" placeholder="https://www.notion.so/... (base de Bio Settings)">
        </label>

        <details class="help">
          <summary>+ Qué debe contener</summary>
          <div class="help-body small">
            Puedes usar el template de Bio o tu propia base. Si lo dejas vacío, el widget solo usará tu Grid.
          </div>
        </details>

        <label class="field">
          <input id="confirmIntegration" type="checkbox"> &nbsp;
          <span>Sí, conecté la integración a mi(s) base(s) de Notion</span>
        </label>

        <button id="btnGenerate" class="primary">Generar Widget →</button>

        <div id="result" class="alert" style="display:none;margin-top:14px"></div>
      </div>
    </section>

    <!-- Help (FAQs “buenas”) -->
    <section id="tab-help" style="display:none">
      <h1>Preguntas Frecuentes</h1>

      <details class="card">
        <summary><strong>¿Cómo empiezo con el widget?</strong></summary>
        <div class="small">
          Ve a <em>Setup</em>, pega tu Integration Token y las URLs de las bases (Grid + Bio). Pulsa “Generar Widget”.
          Copia la URL resultante y embébela en Notion con <code>/embed</code>.
        </div>
      </details>

      <details class="card">
        <summary><strong>¿Cómo configuro correctamente mi base de datos de Notion?</strong></summary>
        <div class="small">
          Tu base debe incluir: <strong>Name</strong> (Text), <strong>Publish Date</strong> (Date), <strong>Attachment</strong> (File).
          Versión Pro: añade <strong>Image Source</strong> (Select), <strong>Link</strong> (Text) y <strong>Canva Link</strong> (URL).
        </div>
      </details>

      <details class="card">
        <summary><strong>¿Por qué el widget no puede acceder a mi base?</strong></summary>
        <div class="small">
          Asegúrate de copiar la URL de la base fuente (no una vista vinculada), de abrirla en vista de página completa y de haber conectado la integración a esa base.
        </div>
      </details>

      <details class="card">
        <summary><strong>¿Puedo usar este widget con una base existente?</strong></summary>
        <div class="small">
          Sí. Solo respeta los nombres y tipos de las propiedades especiales. Puedes mantener tus demás columnas.
        </div>
      </details>

      <details class="card">
        <summary><strong>¿Puedo renombrar columnas?</strong></summary>
        <div class="small">
          No. Las columnas especiales deben mantener sus nombres exactos para que el widget funcione.
        </div>
      </details>

      <details class="card">
        <summary><strong>¿Puedo usarlo para múltiples clientes?</strong></summary>
        <div class="small">
          Sí. Crea una base por cliente y repite el Setup. Cada widget tendrá su propia URL única.
        </div>
      </details>

      <details class="card">
        <summary><strong>¿Cómo incrusto diseños de Canva? (Pro)</strong></summary>
        <div class="small">
          En <em>Image Source</em> elige <em>Canva Design</em>, y pega en <em>Canva Link</em> el enlace de “Embed” desde Canva (no el URL del navegador).
        </div>
      </details>

      <p class="small">Soporte: <a href="mailto:emiliagrijalvao@gmail.com">emiliagrijalvao@gmail.com</a></p>
    </section>

    <!-- Account (sin cambios funcionales) -->
    <section id="tab-account" style="display:none">
      <h1>Información de la cuenta</h1>
      <div id="acctWarn" class="alert err">Falta el token en la URL. Usa el enlace de tu email.</div>

      <div id="acctBox" class="card" style="display:none">
        <table class="faq" border="1" cellpadding="8">
          <tbody>
            <tr><td>Email</td><td id="acctEmail">usuario@ejemplo.com</td></tr>
            <tr><td>Nombre</td><td id="acctName">Nombre del Usuario</td></tr>
            <tr><td>Tipo de cuenta</td><td id="acctPlan">Basic Account</td></tr>
          </tbody>
        </table>

        <h3>Licencias</h3>
        <div class="card small">Basic License Key<br>XXXX-XXXX-XXXX-XXXX</div>

        <h3>Tus Widgets (0)</h3>
        <div id="acctWidgets" class="small">—</div>
      </div>
    </section>
  </div>

  <script>
    // Tabs
    const tabs = ["start","setup","help","account"];
    function showTab(name){
      tabs.forEach(t=>{
        document.getElementById("tab-"+t)?.setAttribute("style", t===name? "":"display:none");
        document.querySelector(`a[data-tab="${t}"]`)?.classList.toggle("active", t===name);
      });
      history.replaceState({}, "", name==="start"? "/setup/": `/setup/#${name}`);
    }
    document.querySelectorAll("nav a").forEach(a=>{
      a.addEventListener("click", e=>{
        e.preventDefault();
        showTab(a.dataset.tab);
      });
    });
    (function initTab(){
      const h = location.hash.replace("#","");
      showTab(tabs.includes(h)? h : "start");
    })();

    // Setup: generar widget
    async function generateWidget(){
      const email        = (document.getElementById('email')?.value || '').trim();
      const notionToken  = (document.getElementById('notionToken')?.value || '').trim();
      const gridDbUrl    = (document.getElementById('gridDbUrl')?.value || '').trim();
      const bioDbUrl     = (document.getElementById('bioDbUrl')?.value || '').trim();
      const confirmed    = document.getElementById('confirmIntegration')?.checked;

      const box = document.getElementById('result');
      const say = (msg, ok=false)=>{
        box.style.display='block';
        box.className = 'alert ' + (ok? 'ok':'err');
        box.textContent = msg;
      };

      if(!confirmed){ say('Marca la casilla de confirmación de integración'); return; }
      if(!notionToken || !gridDbUrl){ say('Faltan campos: token y/o URL de la base de Grid'); return; }

      const payload = {
        email: email || null,
        notion_token: notionToken,
        grid_db_url: gridDbUrl,
        bio_db_url: bioDbUrl || null
      };

      try{
        const res = await fetch('/api/widgets/create', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(()=> ({}));
        if(!res.ok){ throw new Error(data?.error || JSON.stringify(data) || 'Server error'); }

        // Espera que el API devuelva { ok: true, id: 'xxxxx' }
        if(data?.id){
          const url = `/widget?id=${encodeURIComponent(data.id)}`;
          say(`¡Listo! Copia y pega esta URL en Notion con /embed: ${url}`, true);
        }else{
          say('Respuesta inesperada del servidor'); 
        }
      }catch(err){
        say(`No se pudo generar el widget: ${String(err.message || err)}`);
      }
    }
    document.getElementById('btnGenerate')?.addEventListener('click', generateWidget);
  </script>
</body>
</html>
