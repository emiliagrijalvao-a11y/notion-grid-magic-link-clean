<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Widget Setup · Flujo Creativo</title>

  <!-- Fuentes -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Oswald:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    :root{
      --beige:#D9D9D9;
      --tile:#ECEBE8;
      --black:#000000;
      --white:#ffffff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Inter",system-ui,-apple-system,sans-serif;
      color:var(--black);
      background:var(--beige);
      -webkit-font-smoothing:antialiased;
    }
    .wrap{max-width:1080px;margin:0 auto;padding:32px 20px 80px}

    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
    .brand{font-family:"Oswald",sans-serif;letter-spacing:.5px;font-size:22px;text-transform:uppercase}

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.35), rgba(255,255,255,.15));
      border:1px solid rgba(0,0,0,.12);
      padding:32px 28px;
    }

    h1{
      font-family:"Oswald",sans-serif;
      font-weight:600;
      font-size:36px;
      line-height:1.1;
      margin:0 0 8px;
    }
    p{line-height:1.6;margin:0 0 16px}

    .form-group{margin:18px 0}
    .form-group label{display:block;font-weight:600;margin-bottom:8px;font-size:15px}
    .form-group input[type="text"]{
      width:100%;
      padding:12px;
      border:1px solid rgba(0,0,0,.2);
      background:var(--white);
      font-size:14px;
      font-family:inherit;
    }
    .form-help{font-size:13px;color:#555;margin-top:6px}

    .collapsible{
      color:var(--black);
      text-decoration:underline;
      cursor:pointer;
      font-size:14px;
      display:inline-block;
      font-weight:600;
      margin-top:8px;
    }
    .collapsible-content{display:none;margin-top:12px}
    .collapsible-content.open{display:block}

    .toggle{display:flex;align-items:center;gap:12px;margin:18px 0}
    .toggle input[type="checkbox"]{width:18px;height:18px;cursor:pointer}

    .btn{
      background:var(--black);
      color:var(--white);
      border:none;
      padding:12px 20px;
      font-size:14px;
      cursor:pointer;
      display:inline-block;
      text-decoration:none;
    }
    .btn:hover{opacity:.9}
    .btn-secondary{
      background:var(--tile);
      color:var(--black);
      border:1px solid rgba(0,0,0,.3);
    }

    #widget-result{
      display:none;
      margin-top:24px;
      padding:20px;
      background:rgba(0,128,0,.08);
      border:1px solid rgba(0,128,0,.25)
    }
    code.inline{
      background:rgba(0,0,0,.08);
      padding:2px 6px;
      font-family:ui-monospace,monospace;
      font-size:13px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">Flujo Creativo</div>
    </header>

    <div class="card">
      <h1>Widget Setup</h1>
      <p>Ingresa tu <span class="inline">Notion Integration Token</span> y los enlaces a tus bases de datos. Marca la casilla de confirmación y genera tu URL del widget.</p>

      <!-- Token -->
      <div class="form-group">
        <label for="token-input">Notion Integration Token</label>
        <input type="text" id="token-input" placeholder="secret_xxxxx..." />
        <span class="collapsible" data-target="token-instructions">+ Instrucciones</span>
        <div class="collapsible-content" id="token-instructions">
          <ol style="font-size:14px;line-height:1.7;margin:6px 0 0">
            <li>Ve a la <a href="https://www.notion.so/my-integrations" target="_blank">página de Integraciones de Notion</a>.</li>
            <li>Crea una integración “Internal”.</li>
            <li>Copia tu <strong>Integration Token</strong> y pégalo aquí.</li>
            <li>Conecta esa integración a tus bases desde el menú ••• → <strong>Connections</strong>.</li>
          </ol>
        </div>
      </div>

      <!-- Grid DB -->
      <div class="form-group">
        <label for="db-input">Database URL (Grid)</label>
        <input type="text" id="db-input" placeholder="https://www.notion.so/tu_workspace/..." />
        <div class="form-help">Copia el enlace directo de la base de datos (vista de página completa, no una vista vinculada).</div>
        <span class="collapsible" data-target="db-instructions">+ Cómo obtener este enlace</span>
        <div class="collapsible-content" id="db-instructions">
          <ol style="font-size:14px;line-height:1.7;margin:6px 0 0">
            <li>Abre la base en Notion (página completa).</li>
            <li>••• → <strong>Copy link</strong> o copia desde la barra del navegador.</li>
          </ol>
        </div>
      </div>

      <!-- Bio DB (opcional) -->
      <div class="form-group">
        <label for="bio-input">Bio Database URL (opcional)</label>
        <input type="text" id="bio-input" placeholder="https://www.notion.so/tu_bio_db/..." />
        <span class="collapsible" data-target="bio-instructions">+ Qué debe contener</span>
        <div class="collapsible-content" id="bio-instructions">
          <p style="font-size:14px;margin:6px 0 0">
            Debe incluir, al menos: <code class="inline">Display Name (Text)</code>, <code class="inline">Bio (Text)</code>, <code class="inline">Avatar (Files & Media)</code> (opcional).
          </p>
        </div>
      </div>

      <!-- ✅ Confirmación -->
      <div class="toggle">
        <input type="checkbox" id="integration-done" />
        <label for="integration-done">Sí, conecté la integración a mi(s) base(s) de Notion</label>
      </div>

      <!-- Botón (type="button" para no enviar form) -->
      <button class="btn" id="generate-widget" type="button">Generar Widget →</button>

      <!-- Resultado -->
      <div id="widget-result">
        <h3 style="margin:0 0 8px">¡Widget generado!</h3>
        <p style="margin:0 0 8px">Tu widget URL:</p>
        <code id="widget-url" style="display:block;padding:12px;background:var(--white);margin:8px 0">https://tu-dominio.com/widget/xxxxx</code>
        <button class="btn btn-secondary" id="copy-widget-url" type="button">Copiar URL</button>
      </div>
    </div>
  </div>

  <script>
    // Abre/cierra bloques de ayuda
    document.querySelectorAll('.collapsible').forEach(trigger => {
      trigger.addEventListener('click', () => {
        const id = trigger.dataset.target;
        const el = document.getElementById(id);
        el.classList.toggle('open');
        trigger.textContent = el.classList.contains('open') ? '− Ocultar' : '+ ' + trigger.textContent.replace(/^(\+ |− )/, '');
      });
    });

    // Handler robusto del botón (valida el checkbox)
    (function () {
      const btn = document.getElementById('generate-widget');
      const chk = document.getElementById('integration-done');
      const copyBtn = document.getElementById('copy-widget-url');

      copyBtn.addEventListener('click', () => {
        const txt = document.getElementById('widget-url').textContent.trim();
        navigator.clipboard.writeText(txt);
        copyBtn.textContent = 'Copiado ✓';
        setTimeout(() => (copyBtn.textContent = 'Copiar URL'), 1200);
      });

      btn.addEventListener('click', async (e) => {
        e.preventDefault();

        if (!chk) {
          alert('No se encontró el control de confirmación. Recarga la página.');
          return;
        }
        if (!chk.checked) {
          alert('Marca la casilla de confirmación de integración');
          return;
        }

        const token = document.getElementById('token-input')?.value?.trim();
        const gridUrl = document.getElementById('db-input')?.value?.trim();
        const bioUrl  = document.getElementById('bio-input')?.value?.trim();

        if (!token || !gridUrl) {
          alert('Completa Token y Database URL');
          return;
        }

        try {
          const res = await fetch('/api/widgets/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              notion_token: token,
              grid_db_url: gridUrl,
              bio_db_url: bioUrl || null
            })
          });

          const data = await res.json();
          if (!res.ok || !data?.success) {
            throw new Error(data?.error || 'Error desconocido creando widget');
          }

          document.getElementById('widget-url').textContent = data.widgetUrl;
          document.getElementById('widget-result').style.display = 'block';
          document.getElementById('widget-result').scrollIntoView({ behavior: 'smooth' });
        } catch (err) {
          alert('No se pudo generar el widget: ' + err.message);
        }
      });
    })();
  </script>
</body>
</html>
