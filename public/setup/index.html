<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Widget Setup · Flujo Creativo</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Oswald:wght@300;400;600&display=swap" rel="stylesheet" />
  <style>
    :root{--beige:#D9D9D9;--tile:#ECEBE8;--black:#000;--white:#fff}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,sans-serif;color:var(--black);background:var(--beige)}
    .wrap{max-width:880px;margin:0 auto;padding:32px 20px 64px}
    h1{font-family:Oswald,Inter,sans-serif;font-size:40px;letter-spacing:.3px;margin:0 0 12px}
    p{line-height:1.6;margin:0 0 14px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.35),rgba(255,255,255,.15));border:1px solid rgba(0,0,0,.12);padding:28px}
    .form-group{margin:18px 0}
    .form-group label{display:block;font-weight:700;margin-bottom:8px}
    input[type="text"]{width:100%;padding:12px;border:1px solid rgba(0,0,0,.2);background:#fff;font-size:14px}
    input[type="text"]:focus{outline:2px solid var(--black);outline-offset:1px}
    .hint{font-size:13px;color:#555}
    .collapsible{color:var(--black);text-decoration:underline;cursor:pointer;font-size:14px;display:inline-block;margin-top:8px}
    .collapsible-content{display:none;margin-top:10px}
    .collapsible-content.open{display:block}
    .toggle{display:flex;align-items:center;gap:10px;margin:16px 0}
    .btn{background:var(--black);color:#fff;border:1px solid #000;padding:12px 20px;font-weight:600;cursor:pointer}
    .result{display:none;margin-top:20px;padding:16px;background:rgba(0,255,0,.08);border:1px solid rgba(0,128,0,.3)}
    code.block{display:block;background:#fff;border:1px solid rgba(0,0,0,.15);padding:10px;word-break:break-all}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Widget Setup</h1>
      <p>Ingresa tu Notion Integration Token y los enlaces a tus bases de datos para generar tu widget.</p>

      <!-- Token -->
      <div class="form-group">
        <label for="token-input">Notion Integration Token</label>
        <input type="text" id="token-input" placeholder="secret_xxxxx..." />
        <span class="collapsible" data-target="token-instructions">+ Instrucciones</span>
        <div class="collapsible-content" id="token-instructions">
          <ol style="font-size:14px;line-height:1.7;margin:8px 0 0">
            <li>Ve a <a href="https://www.notion.so/my-integrations" target="_blank">Notion Integrations</a> y crea una integración nueva.</li>
            <li>Selecciona <strong>Internal</strong>, copia el <strong>Integration Token</strong> y pégalo aquí.</li>
            <li>El mismo token puede usarse para varios widgets.</li>
          </ol>
        </div>
      </div>

      <!-- Confirmación de integración -->
      <div class="form-group">
        <label>Confirma que conectaste la integración a tu base</label>
        <div class="toggle">
          <input type="checkbox" id="integration-done" />
          <label for="integration-done">Sí, ya está conectada</label>
        </div>
      </div>

      <!-- Grid DB -->
      <div class="form-group">
        <label for="db-input">Database URL (Grid)</label>
        <input type="text" id="db-input" placeholder="https://www.notion.so/workspace/..." />
        <p class="hint">Copia el enlace directo de la base de datos (vista de página completa, no una vista vinculada).</p>
        <span class="collapsible" data-target="db-instructions">+ Cómo obtener este enlace</span>
        <div class="collapsible-content" id="db-instructions">
          <ol style="font-size:14px;line-height:1.7;margin:8px 0 0">
            <li>Abre tu base de datos de contenido en Notion en vista de página completa.</li>
            <li>Usa <strong>••• → Copy link</strong> o copia la URL de la barra del navegador.</li>
            <li>Asegúrate de que sea la base de datos <strong>fuente</strong>, no una vista vinculada.</li>
          </ol>
        </div>
      </div>

      <!-- Bio DB (opcional) -->
      <div class="form-group">
        <label for="bio-input">Bio Database URL (opcional)</label>
        <input type="text" id="bio-input" placeholder="https://www.notion.so/tu_bio_db/..." />
        <span class="collapsible" data-target="bio-instructions">+ Qué debe contener</span>
        <div class="collapsible-content" id="bio-instructions">
          <p class="hint" style="margin-top:0">Úsalo solo si también mostrarás un <strong>Bio Widget</strong>. Si no, déjalo en blanco.</p>
          <p style="font-size:14px"><strong>Propiedades sugeridas (ejemplo):</strong></p>
          <ul style="font-size:14px;line-height:1.7;margin-top:6px">
            <li><code>Title</code> — Text</li>
            <li><code>Subtitle</code> — Text</li>
            <li><code>Avatar</code> — Files &amp; Media</li>
            <li><code>Links</code> — Text o Relation</li>
            <li><code>Is Published</code> — Checkbox</li>
          </ul>
        </div>
      </div>

      <!-- Botón -->
      <button class="btn" id="generate-widget">Generar Widget →</button>

      <!-- Resultado (si lo quieres mostrar en pantalla) -->
      <div class="result" id="widget-result">
        <strong>¡Widget generado!</strong>
        <p>Tu Widget URL:</p>
        <code class="block" id="widget-url">https://example.com/widget/xxxxx</code>
      </div>
    </div>
  </div>

  <script>
    // Collapsibles
    document.querySelectorAll('.collapsible').forEach(trigger => {
      trigger.addEventListener('click', () => {
        const id = trigger.dataset.target;
        const box = document.getElementById(id);
        box.classList.toggle('open');
        trigger.textContent = box.classList.contains('open')
          ? '- Ocultar instrucciones' : '+ ' + trigger.textContent.replace(/^[\+\-]\s*/, '');
      });
    });

    // Generar widget
    document.getElementById('generate-widget').addEventListener('click', async () => {
      const token = document.getElementById('token-input').value.trim();
      const gridUrl = document.getElementById('db-input').value.trim();
      const bioUrl  = document.getElementById('bio-input').value.trim(); // ← Bio (opcional)
      const done = document.getElementById('integration-done').checked;

      if (!token || !gridUrl) {
        alert('Completa el token y la URL de la base de datos del Grid.');
        return;
      }
      if (!done) {
        alert('Marca la casilla de confirmación de integración');
        return;
      }

      try {
        const resp = await fetch('/api/widgets/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            notion_token: token,
            grid_db_url: gridUrl,
            bio_db_url: bioUrl || null  // ← se envía si existe
          })
        });

        const data = await resp.json();

        if (!resp.ok || !data.ok) {
          throw new Error(data?.error || 'Error generando el widget');
        }

        // Mostrar resultado (sin cambiar tu UI si no existiera el bloque)
        const box = document.getElementById('widget-result');
        const out = document.getElementById('widget-url');
        if (box && out) {
          out.textContent = data.widget_url;
          box.style.display = 'block';
          box.scrollIntoView({ behavior: 'smooth' });
        } else {
          alert('Widget creado: ' + data.widget_url);
        }
      } catch (e) {
        alert('No se pudo generar el widget: ' + (e?.message || e));
        console.error(e);
      }
    });
  </script>
</body>
</html>
