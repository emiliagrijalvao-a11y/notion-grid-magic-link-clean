<script>
  // BOTÓN: Generar Widget (usa tu form actual: token, db y bio db si existe)
  document.getElementById('generate-widget').addEventListener('click', async () => {
    const token = document.getElementById('token-input')?.value?.trim();     // no lo guardamos aún en DB
    const gridDbUrl = document.getElementById('db-input')?.value?.trim();
    const bioDbUrl = document.getElementById('bio-input')?.value?.trim() || null;
    const integrationDone = document.getElementById('integration-done')?.checked;
    const email = document.getElementById('customer-email')?.value?.trim() || ''; // si tienes ese campo

    if (!gridDbUrl) { alert('Pega la URL de tu base de datos de Notion (Grid)'); return; }
    if (!integrationDone) { alert('Marca que conectaste la integración a la base.'); return; }

    try {
      const r = await fetch('/api/widgets/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: email || 'cliente@example.com',
          gridDbUrl,
          bioDbUrl: bioDbUrl || undefined,
          plan: (new URLSearchParams(location.search).get('plan') === 'pro') ? 'pro' : 'basic'
        })
      });

      const data = await r.json();
      if (!r.ok || !data.ok) throw new Error(data.error || 'Error al crear el widget');

      // Muestra las URLs estables para copiar/pegar en Notion
      document.getElementById('widget-url').textContent = data.gridEmbedUrl;
      document.getElementById('widget-result').style.display = 'block';

      const bioBlock = document.getElementById('bio-result');
      if (data.bioEmbedUrl && bioBlock) {
        document.getElementById('bio-url').textContent = data.bioEmbedUrl;
        bioBlock.style.display = 'block';
      } else if (bioBlock) {
        bioBlock.style.display = 'none';
      }

      // Opcional: scroll al resultado
      document.getElementById('widget-result').scrollIntoView({ behavior: 'smooth' });
    } catch (err) {
      alert('No se pudo generar el widget: ' + err.message);
    }
  });
</script>
